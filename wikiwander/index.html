<!doctype html>
<html lang="en">
<head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-20EEFX7Q6N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-20EEFX7Q6N');
</script>


  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>WikiWander</title>

  <!-- Favicon / App icon -->
  <link rel="icon" type="image/png" href="assets/wikiwander_logo_squared.png">
  <link rel="apple-touch-icon" href="assets/wikiwander_logo_squared.png">

  <style>
    :root{
      color-scheme: dark;
      --bg:#070A10;
      --stroke:#24304A;
      --stroke2:#2A3856;
      --text:#EAF0FF;
      --muted:#A9B5D1;
      --muted2:#8693B4;
      --accent:#00f2ff;
      --card: rgba(11,16,32,.92);
      --r:20px;

      --title: clamp(22px, 5.2vw, 32px);
      --concept: clamp(16px, 3.8vw, 20px);
      --meta: clamp(12px, 3.2vw, 13px);
      --pad: clamp(10px, 3.2vw, 16px);
      --mediaH: clamp(120px, 28vw, 220px);
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0;
      padding:0;
      width:100%;
      height:auto;
      overflow-x:hidden;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(143,182,255,.18), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(124,255,178,.10), transparent 55%),
        radial-gradient(800px 500px at 60% 110%, rgba(255,124,124,.08), transparent 55%),
        var(--bg);
      color:var(--text);

      padding:
        max(12px, env(safe-area-inset-top))
        max(12px, env(safe-area-inset-right))
        max(12px, env(safe-area-inset-bottom))
        max(12px, env(safe-area-inset-left));
    }

    .app{
      width: min(760px, 100%);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topbar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      min-width: 0;
    }

    .logo-img{
      height: 20px;
      width: auto;
      max-width: 140px;
      display:block;
    }

    .brand .name{
      font-weight:900;
      letter-spacing:-.2px;
      font-size: 22px;
      line-height: 1;
      white-space: nowrap;
    }

    .lang-switch{
      display:flex;
      gap:6px;
      flex: 0 0 auto;
    }
    .lang-switch .lang-btn{
      background: transparent;
      border: 1px solid rgba(255,255,255,.15);
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      line-height: 1;
    }
    .lang-switch .lang-btn.active{
      border-color: rgba(0,242,255,.65);
      color: var(--text);
      background: rgba(0,242,255,.10);
    }

    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,23,38,.75);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .err{ color:#ffd1d1; }

    .panel{
      width:100%;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), rgba(10,15,26,.92));
      border-radius: var(--r);
      padding: var(--pad);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    .topicsHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .topicsHeader .label{
      font-size:13px;
      letter-spacing:.3px;
      color:var(--muted);
      font-weight:750;
    }

    .chipGrid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      overflow: visible;
      padding-bottom: 0;
    }

    .chip{
      flex:0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(18,23,38,.9);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; gap:8px;
      min-height:40px;
      white-space:nowrap;
    }
    .chip:hover{ border-color: var(--stroke2); transform: translateY(-1px); }
    .chip.active{
      border-color: rgba(0,242,255,.55);
      background: rgba(0,242,255,.08);
    }
    .chip .name{ font-size:13px; font-weight:800; }
    .chip .dot{ width:6px; height:6px; border-radius:999px; background: rgba(0,242,255,.75); }

    /* Custom topic mini UI */
    .customWrap{
      width:100%;
      margin-top:10px;
      display:none;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .customWrap.show{ display:flex; }
    .customInput{
      flex: 1 1 220px;
      min-width: 160px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(18,23,38,.55);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline: none;
      font-size: 14px;
      font-weight: 650;
    }
    .customInput::placeholder{ color: rgba(169,181,209,.75); }
    .customBtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,23,38,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      line-height:1;
    }
    .customBtn:hover{ border-color: rgba(255,255,255,.16); transform: translateY(-1px); }
    .customBtn.primary{
      border-color: rgba(0,242,255,.45);
      background: rgba(0,242,255,.14);
    }
    .customBtn.primary:hover{
      border-color: rgba(0,242,255,.70);
      background: rgba(0,242,255,.18);
    }

    .card{
      width:100%;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), rgba(10,15,26,.92));
      border-radius: var(--r);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }

    .media{
      height: var(--mediaH);
      position:relative;
      background:
        radial-gradient(800px 360px at 20% 10%, rgba(0,242,255,.16), transparent 55%),
        radial-gradient(600px 320px at 80% 30%, rgba(255,124,124,.12), transparent 60%),
        radial-gradient(700px 420px at 60% 110%, rgba(124,255,178,.10), transparent 60%),
        #070A10;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .media img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
      filter:saturate(1.05) contrast(1.03);
    }
    .media .tag{
      position:absolute;
      left:12px; top:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(9,12,18,.45);
      backdrop-filter: blur(8px);
      font-size:12px;
      color:var(--muted);
    }

    .body{ padding: var(--pad); }

    .title{
      margin:0;
      font-size: var(--title);
      line-height:1.06;
      letter-spacing:-.3px;
      font-weight:900;
      word-break: break-word;
    }

    .meta{
      margin-top:8px;
      font-size: var(--meta);
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .meta a{ color:var(--accent); text-decoration:none; }
    .meta a:hover{ text-decoration:underline; }

    .concept{
      margin-top:12px;
      font-size: var(--concept);
      line-height:1.34;
      letter-spacing:-.1px;
      word-break: break-word;
    }

    .controls{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .leftControls, .rightControls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,23,38,.9);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-size:14px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      line-height:1;
      max-width: 100%;
    }
    .btn:hover{ border-color: rgba(255,255,255,.16); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn--ghost{ background: rgba(18,23,38,.55); }

    .btn--primary{
      border-color: rgba(0,242,255,.45);
      background: rgba(0,242,255,.14);
    }
    .btn--primary:hover{
      border-color: rgba(0,242,255,.70);
      background: rgba(0,242,255,.18);
    }

    .btn--save.saved{
      border-color: rgba(0,242,255,.60);
      background: rgba(0,242,255,.12);
    }

    details.about{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(9,12,18,.35);
      border-radius:16px;
      padding:10px 12px;
    }
    details.about > summary{
      list-style:none;
      cursor:pointer;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.about > summary::-webkit-details-marker{ display:none; }
    .aboutBody{
      margin-top:10px;
      color: var(--muted);
      line-height:1.55;
      font-size: 14px;
    }
    .aboutBody ul{ margin: .6rem 0 0 1.1rem; }

    .hint{
      color:var(--muted2);
      font-weight:750;
    }

    .footer{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      color:var(--muted2);
      font-size:12px;
      flex-wrap:wrap;
    }

    .savedWrap{
      width:100%;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(11,16,32,.75), rgba(10,15,26,.78));
      border-radius: var(--r);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .savedHead{
      padding: 12px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .savedHead .t{
      font-weight:900;
      color: var(--text);
      letter-spacing:-.2px;
    }
    .savedHead .small{
      color: var(--muted2);
      font-size:12px;
    }
    .savedBody{
      padding: 12px 16px 16px;
    }
    .savedList{
      margin:0;
      padding-left: 18px;
      color: var(--muted);
      line-height:1.55;
      word-break: break-word;
    }
    .savedList a{
      color: var(--accent);
      text-decoration:none;
    }
    .savedList a:hover{ text-decoration:underline; }
    .savedEmpty{
      color: var(--muted2);
      font-size: 13px;
      margin:0;
    }
    .btn--tiny{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:850;
      background: rgba(18,23,38,.55);
    }

    @media (max-width: 560px){
      .topbar{ flex-direction: column; align-items:flex-start; }
      .pill{ width:100%; justify-content:space-between; }
      .lang-switch{ width:100%; }
      .controls{
        flex-direction: column;
        align-items: stretch;
      }
      .leftControls, .rightControls{
        width:100%;
      }
      .btn{
        width:100%;
      }
      .logo-img{
        height: 18px;
        max-width: 120px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand" aria-label="app title">
        <img src="assets/wikiwander_logo.png" alt="WikiWander logo" class="logo-img">
        <span class="name">WikiWander</span>
      </div>

      <div class="lang-switch" aria-label="Language selector">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
        <button class="lang-btn" data-lang="fr">FR</button>
        <button class="lang-btn" data-lang="de">DE</button>
      </div>

      <div class="pill" id="statusPill">
        <span id="statusText">Loading…</span>
        <span>·</span>
        <span data-i18n="savedLabel">Saved:</span>
        <span id="savedCount">0</span>
      </div>
    </div>

    <section class="panel">
      <div class="topicsHeader">
        <div class="label" data-i18n="topics">Topics</div>
      </div>
      <div class="chipGrid" id="chipRow"></div>

      <!-- Custom topic search bar (only shows when Custom selected) -->
      <div class="customWrap" id="customWrap" aria-label="Custom search">
        <input id="customInput" class="customInput" type="text"
               placeholder="Search Wikipedia…"
               autocomplete="off" spellcheck="false">
        <button id="customApply" class="customBtn primary">Apply</button>
        <button id="customCancel" class="customBtn">Cancel</button>
      </div>
    </section>

    <main class="card" id="card">
      <div class="media">
        <img id="img" alt=""/>
        <div class="tag" id="tag">Random</div>
      </div>

      <div class="body">
        <h1 class="title" id="title">Loading…</h1>

        <div class="meta">
          <span data-i18n="fromWikipedia">From Wikipedia</span>
          <span id="metaTopic">· Random</span>
          <a id="openLink" href="#" target="_blank" rel="noopener" data-i18n="open">open</a>
        </div>

        <div class="concept" id="concept">Fetching a concept…</div>

        <div class="controls">
          <div class="leftControls">
            <button class="btn btn--ghost" id="back" title="Back" aria-label="Back">← <span data-i18n="back">Back</span></button>
          </div>

          <div class="rightControls">
            <button class="btn btn--primary" id="next" title="Next" aria-label="Next"><span data-i18n="next">Next</span> →</button>
            <button class="btn" id="open" title="Open article" aria-label="Open article"><span data-i18n="article">Article</span></button>
            <button class="btn btn--save" id="save" title="Save" aria-label="Save">★ <span data-i18n="save">Save</span></button>
          </div>
        </div>

        <details class="about" id="about">
          <summary>
            <span data-i18n="whatIs">What is WikiWander?</span>
            <span class="hint" data-i18n="tap">tap</span>
          </summary>
          <div class="aboutBody">
            <p data-i18n="aboutText">
              WikiWander is a quick way to discover unexpected knowledge.
              Each card shows a short excerpt from Wikipedia, chosen at random or by topic.
            </p>
            <ul>
              <li><strong data-i18n="aboutNext">Next</strong> — <span data-i18n="aboutNextDesc">shows a new idea.</span></li>
              <li><strong data-i18n="aboutSave">Save</strong> — <span data-i18n="aboutSaveDesc">bookmarks it below.</span></li>
              <li><strong data-i18n="aboutArticle">Article</strong> — <span data-i18n="aboutArticleDesc">opens the full page on Wikipedia.</span></li>
            </ul>
          </div>
        </details>

        <div class="footer">
          <span id="errorText"></span>
          <span data-i18n="tip">Tip: topics bias the randomness (they don’t guarantee it).</span>
        </div>
      </div>
    </main>

    <section class="savedWrap" aria-label="Saved">
      <div class="savedHead">
        <div>
          <div class="t" data-i18n="savedTitle">Saved</div>
          <div class="small" data-i18n="savedSubtitle">Your bookmarked Wikipedia pages</div>
        </div>
        <button class="btn btn--tiny" id="clearSaved" title="Clear saved list"><span data-i18n="clear">Clear</span></button>
      </div>
      <div class="savedBody">
        <p class="savedEmpty" id="savedEmpty" data-i18n="noSaved">No saved pages yet.</p>
        <ol class="savedList" id="savedList" style="display:none;"></ol>
      </div>
    </section>
  </div>

<script>
/* =========================
   i18n (UI translations)
   ========================= */
const I18N = {
  en: {
    savedLabel:"Saved:",
    topics:"Topics",
    fromWikipedia:"From Wikipedia",
    open:"open",
    back:"Back",
    next:"Next",
    article:"Article",
    save:"Save",
    whatIs:"What is WikiWander?",
    tap:"tap",
    aboutText:"WikiWander is a quick way to discover unexpected knowledge. Each card shows a short excerpt from Wikipedia, chosen at random or by topic.",
    aboutNext:"Next",
    aboutNextDesc:"shows a new idea.",
    aboutSave:"Save",
    aboutSaveDesc:"bookmarks it below.",
    aboutArticle:"Article",
    aboutArticleDesc:"opens the full page on Wikipedia.",
    tip:"Tip: topics bias the randomness (they don’t guarantee it).",
    savedTitle:"Saved",
    savedSubtitle:"Your bookmarked Wikipedia pages",
    clear:"Clear",
    noSaved:"No saved pages yet.",
    customPlaceholder:"Search Wikipedia…",
    customApply:"Apply",
    customCancel:"Cancel",
    customNeedsQuery:"Please type a search term for your custom topic."
  },
  es: {
    savedLabel:"Guardados:",
    topics:"Temas",
    fromWikipedia:"Desde Wikipedia",
    open:"abrir",
    back:"Atrás",
    next:"Siguiente",
    article:"Artículo",
    save:"Guardar",
    whatIs:"¿Qué es WikiWander?",
    tap:"toca",
    aboutText:"WikiWander es una forma rápida de descubrir conocimiento inesperado. Cada tarjeta muestra un extracto breve de Wikipedia, elegido al azar o por tema.",
    aboutNext:"Siguiente",
    aboutNextDesc:"muestra una nueva idea.",
    aboutSave:"Guardar",
    aboutSaveDesc:"lo guarda abajo.",
    aboutArticle:"Artículo",
    aboutArticleDesc:"abre la página completa en Wikipedia.",
    tip:"Tip: los temas influyen en la aleatoriedad (no la garantizan).",
    savedTitle:"Guardados",
    savedSubtitle:"Tus páginas guardadas de Wikipedia",
    clear:"Borrar",
    noSaved:"Aún no hay páginas guardadas.",
    customPlaceholder:"Buscar en Wikipedia…",
    customApply:"Aplicar",
    customCancel:"Cancelar",
    customNeedsQuery:"Escribe un término para tu tema personal."
  },
  fr: {
    savedLabel:"Enregistrés :",
    topics:"Thèmes",
    fromWikipedia:"Depuis Wikipédia",
    open:"ouvrir",
    back:"Retour",
    next:"Suivant",
    article:"Article",
    save:"Enregistrer",
    whatIs:"Qu’est-ce que WikiWander ?",
    tap:"toucher",
    aboutText:"WikiWander est un moyen rapide de découvrir des connaissances inattendues. Chaque carte affiche un court extrait de Wikipédia, au hasard ou par thème.",
    aboutNext:"Suivant",
    aboutNextDesc:"affiche une nouvelle idée.",
    aboutSave:"Enregistrer",
    aboutSaveDesc:"l’ajoute en bas.",
    aboutArticle:"Article",
    aboutArticleDesc:"ouvre la page complète sur Wikipédia.",
    tip:"Astuce : les thèmes orientent l’aléatoire (sans le garantir).",
    savedTitle:"Enregistrés",
    savedSubtitle:"Tes pages Wikipédia enregistrées",
    clear:"Effacer",
    noSaved:"Aucune page enregistrée pour l’instant.",
    customPlaceholder:"Rechercher sur Wikipédia…",
    customApply:"Appliquer",
    customCancel:"Annuler",
    customNeedsQuery:"Saisis un terme pour ton thème personnalisé."
  },
  de: {
    savedLabel:"Gespeichert:",
    topics:"Themen",
    fromWikipedia:"Aus Wikipedia",
    open:"öffnen",
    back:"Zurück",
    next:"Weiter",
    article:"Artikel",
    save:"Speichern",
    whatIs:"Was ist WikiWander?",
    tap:"tippen",
    aboutText:"WikiWander ist ein schneller Weg, unerwartetes Wissen zu entdecken. Jede Karte zeigt einen kurzen Auszug aus Wikipedia – zufällig oder nach Thema.",
    aboutNext:"Weiter",
    aboutNextDesc:"zeigt eine neue Idee.",
    aboutSave:"Speichern",
    aboutSaveDesc:"merkt es unten vor.",
    aboutArticle:"Artikel",
    aboutArticleDesc:"öffnet die ganze Seite auf Wikipedia.",
    tip:"Tipp: Themen beeinflussen die Zufälligkeit (garantieren sie aber nicht).",
    savedTitle:"Gespeichert",
    savedSubtitle:"Deine gespeicherten Wikipedia-Seiten",
    clear:"Löschen",
    noSaved:"Noch keine gespeicherten Seiten.",
    customPlaceholder:"Wikipedia durchsuchen…",
    customApply:"Anwenden",
    customCancel:"Abbrechen",
    customNeedsQuery:"Bitte gib einen Suchbegriff für dein eigenes Thema ein."
  }
};

const LS_LANG   = "wikiwander_lang_v1";
const LS_SAVED  = "wikiwander_saved_v2";
const LS_RECENT = "wikiwander_recent_v2";
const LS_CHOICE = "wikiwander_choice_v2";
const LS_CUSTOM_QUERY = "wikiwander_custom_query_v1";

const el = (id) => document.getElementById(id);

const state = {
  lang: "en",
  choice: "random",
  customQuery: "",
  current: null,
  history: [],
  saved: [],
  recentTitles: [],
  isLoading: false,

  // Prefetch
  queue: [],
  prefetching: false,
  targetQueue: 4,
};

/* ---------- Language ---------- */
function applyLanguage(lang){
  if (!I18N[lang]) lang = "en";
  state.lang = lang;
  localStorage.setItem(LS_LANG, lang);
  document.documentElement.lang = lang;

  document.querySelectorAll("[data-i18n]").forEach(node=>{
    const key = node.getAttribute("data-i18n");
    const v = I18N[lang][key];
    if (typeof v === "string") node.textContent = v;
  });

  // custom input strings
  el("customInput").placeholder = I18N[lang].customPlaceholder;
  el("customApply").textContent = I18N[lang].customApply;
  el("customCancel").textContent = I18N[lang].customCancel;

  document.querySelectorAll(".lang-btn").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.lang === lang);
  });

  renderChips();

  // Switch Wikipedia source: clear queue + reload content in the new language
  state.queue = [];
  state.history = [];
  next();
}

/* ---------- Wikipedia base ---------- */
function wikiBase(){
  // allow EN/ES/FR/DE
  const allowed = new Set(["en","es","fr","de"]);
  const lang = allowed.has(state.lang) ? state.lang : "en";
  return `https://${lang}.wikipedia.org`;
}

/* ---------- Helpers ---------- */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function loadLocal(){
  try { state.saved = JSON.parse(localStorage.getItem(LS_SAVED) || "[]"); } catch { state.saved = []; }
  try { state.recentTitles = JSON.parse(localStorage.getItem(LS_RECENT) || "[]"); } catch { state.recentTitles = []; }
  const c = localStorage.getItem(LS_CHOICE);
  if (c) state.choice = c;

  const lang = localStorage.getItem(LS_LANG);
  if (lang && I18N[lang]) state.lang = lang;

  state.customQuery = localStorage.getItem(LS_CUSTOM_QUERY) || "";
}

function saveLocal(){
  localStorage.setItem(LS_SAVED, JSON.stringify(state.saved.slice(0, 1000)));
  localStorage.setItem(LS_RECENT, JSON.stringify(state.recentTitles.slice(0, 500)));
  localStorage.setItem(LS_CHOICE, state.choice);
  localStorage.setItem(LS_CUSTOM_QUERY, state.customQuery || "");
}

function setStatus(text, isErr=false){
  el("statusText").innerHTML = isErr ? `<span class="err">${escapeHtml(text)}</span>` : escapeHtml(text);
  el("savedCount").textContent = String(state.saved.length);
}

function setButtonsEnabled(enabled){
  el("back").disabled = !(enabled && state.history.length > 0);
  el("next").disabled = !enabled;
  el("open").disabled = !enabled;
  el("save").disabled = !enabled;
}

function setImage(url){
  const img = el("img");
  if (url){
    img.src = url;
    img.style.display = "block";
  } else {
    img.removeAttribute("src");
    img.style.display = "none";
  }
}

/* ---------- Topics ---------- */
const TOPICS = [
  { key:"random",  label:{en:"Random", es:"Aleatorio", fr:"Aléatoire", de:"Zufall"}, query:null },
  { key:"space",   label:{en:"Astronomy", es:"Astronomía", fr:"Astronomie", de:"Astronomie"}, query:"astronomy OR astrophysics OR galaxy OR cosmology -astrology" },
  { key:"mind",    label:{en:"Mind", es:"Mente", fr:"Esprit", de:"Geist"}, query:"psychology OR neuroscience OR cognition" },
  { key:"history", label:{en:"History", es:"Historia", fr:"Histoire", de:"Geschichte"}, query:"history OR ancient OR medieval OR revolution" },
  { key:"philo",   label:{en:"Philosophy", es:"Filosofía", fr:"Philosophie", de:"Philosophie"}, query:"philosophy OR ethics OR metaphysics OR epistemology" },
  { key:"bio",     label:{en:"Biology", es:"Biología", fr:"Biologie", de:"Biologie"}, query:"biology OR evolution OR genetics OR ecology" },
  { key:"tech",    label:{en:"Tech", es:"Tecnología", fr:"Tech", de:"Technik"}, query:"computer science OR software OR algorithm OR engineering" },
  { key:"art",     label:{en:"Arts", es:"Artes", fr:"Arts", de:"Kunst"}, query:"art OR music OR literature OR cinema" },
  { key:"geo",     label:{en:"Earth", es:"Tierra", fr:"Terre", de:"Erde"}, query:"geology OR climate OR ocean OR volcano" },

  // user-defined search
  { key:"custom",  label:{en:"Custom", es:"Personal", fr:"Perso", de:"Eigene"}, query:"__CUSTOM__" },
];

function topicLabel(t){
  const L = t.label || {};
  return L[state.lang] || L.en || "Random";
}

function renderChips(){
  const row = el("chipRow");
  row.innerHTML = "";

  for (const t of TOPICS){
    const chip = document.createElement("div");
    chip.className = "chip" + (state.choice === t.key ? " active" : "");
    chip.innerHTML = `<span class="dot"></span><span class="name">${escapeHtml(topicLabel(t))}</span>`;
    chip.onclick = () => onTopicChange(t.key);
    row.appendChild(chip);
  }

  const current = TOPICS.find(t => t.key === state.choice) || TOPICS[0];
  const label = topicLabel(current);
  el("tag").textContent = label;
  el("metaTopic").textContent = `· ${label}`;

  // show/hide custom bar
  const showCustom = (current.key === "custom");
  el("customWrap").classList.toggle("show", showCustom);
  if (showCustom){
    el("customInput").value = state.customQuery || "";
    // focus only if user intentionally clicked custom (we’ll focus in onTopicChange too)
  }
}

/* ---------- Saved list ---------- */
function renderSaved(){
  const list = el("savedList");
  const empty = el("savedEmpty");

  if (!state.saved.length){
    empty.style.display = "block";
    list.style.display = "none";
    list.innerHTML = "";
    return;
  }

  empty.style.display = "none";
  list.style.display = "block";
  list.innerHTML = state.saved
    .slice(0, 40)
    .map(item => `<li><a href="${item.url}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a></li>`)
    .join("");
}

function updateSaveButtonState(){
  const btn = el("save");
  const c = state.current;
  if (!c){ btn.classList.remove("saved"); return; }
  const isSaved = state.saved.some(x => x.url === c.url);
  btn.classList.toggle("saved", isSaved);
}

/* ---------- Excerpt ---------- */
function leadParagraph(text){
  if (!text) return "";
  return text
    .split(/\n{2,}/g)
    .map(p => p.trim())
    .filter(Boolean)[0] || text.trim();
}

function clampWords(text, maxWords){
  const words = (text || "").trim().split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return (text || "").trim();
  return words.slice(0, maxWords).join(" ") + "…";
}

function adaptiveMaxWords(){
  const w = window.innerWidth;
  if (w < 420) return 120;
  if (w < 600) return 150;
  if (w < 900) return 180;
  return 210;
}

function adaptiveExcerpt(text){
  return clampWords(leadParagraph(text), adaptiveMaxWords());
}

window.addEventListener("resize", () => {
  if (state.current) el("concept").textContent = adaptiveExcerpt(state.current.extract);
});

/* ---------- De-dupe ---------- */
function rememberTitle(title){
  if (!title) return;
  state.recentTitles.unshift(title);
  state.recentTitles = [...new Set(state.recentTitles)].slice(0, 500);
  saveLocal();
}

/* ---------- Networking ---------- */
const FETCH_TIMEOUT_MS = 9000;
const MAX_ATTEMPTS = 60;
const BACKOFF_BASE_MS = 120;

async function fetchWithTimeout(url, options={}){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);
  try{
    return await fetch(url, { ...options, signal: controller.signal });
  } finally {
    clearTimeout(t);
  }
}

async function jsonOrThrow(res){
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return await res.json();
}

function isBadSummary(s){
  if (!s) return true;
  if (s.type === "disambiguation") return true;
  const t = s.title || "";
  if (/^(Category:|Help:|Wikipedia:|Template:|File:|Portal:|Draft:|Special:)/i.test(t)) return true;
  if (!s.extract) return true;
  return false;
}

async function fetchRandomTitle(){
  const url = new URL(`${wikiBase()}/w/api.php`);
  url.searchParams.set("action","query");
  url.searchParams.set("list","random");
  url.searchParams.set("rnnamespace","0");
  url.searchParams.set("rnlimit","1");
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  return j?.query?.random?.[0]?.title || null;
}

async function fetchSummaryByTitle(title){
  const url = `${wikiBase()}/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
  const res = await fetchWithTimeout(url, { headers: { "accept":"application/json" }});
  return await jsonOrThrow(res);
}

async function searchTotalHits(query){
  const url = new URL(`${wikiBase()}/w/api.php`);
  url.searchParams.set("action","query");
  url.searchParams.set("list","search");
  url.searchParams.set("srsearch", query);
  url.searchParams.set("srnamespace","0");
  url.searchParams.set("srlimit","1");
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  return j?.query?.searchinfo?.totalhits || 0;
}

async function searchTitles(query, offset, limit=30){
  const url = new URL(`${wikiBase()}/w/api.php`);
  url.searchParams.set("action","query");
  url.searchParams.set("list","search");
  url.searchParams.set("srsearch", query);
  url.searchParams.set("srnamespace","0");
  url.searchParams.set("srlimit", String(limit));
  url.searchParams.set("sroffset", String(offset));
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  return (j?.query?.search || []).map(x => x.title);
}

async function makeCardFromSummary(summary){
  const title = summary.title;
  const url = summary?.content_urls?.desktop?.page || `${wikiBase()}/wiki/${encodeURIComponent(title)}`;
  const imageUrl = summary?.thumbnail?.source || summary?.originalimage?.source || null;
  return { title, extract: summary.extract, url, imageUrl, ts:new Date().toISOString() };
}

async function getNextCard(){
  const topic = TOPICS.find(t => t.key === state.choice) || TOPICS[0];

  for (let attempt=0; attempt<MAX_ATTEMPTS; attempt++){
    try{
      let title = null;

      if (topic.key === "random" || !topic.query){
        title = await fetchRandomTitle();
      } else {
        const query = (topic.query === "__CUSTOM__") ? (state.customQuery || "").trim() : topic.query;

        if (topic.key === "custom" && !query){
          throw new Error(I18N[state.lang]?.customNeedsQuery || "Please type a search term for your custom topic.");
        }

        const total = await searchTotalHits(query);
        const cap = Math.min(total, 5000);
        const offset = cap > 0 ? Math.floor(Math.random() * cap) : 0;
        const titles = await searchTitles(query, offset, 30);
        title = titles.length ? titles[Math.floor(Math.random() * titles.length)] : await fetchRandomTitle();
      }

      if (!title) continue;
      if (state.recentTitles.includes(title)) continue;

      const s = await fetchSummaryByTitle(title);
      if (isBadSummary(s)) continue;

      const card = await makeCardFromSummary(s);
      rememberTitle(card.title);
      return card;

    } catch (e){
      // for custom empty query, rethrow immediately
      if (topic.key === "custom" && String(e?.message || "").includes("search term")){
        throw e;
      }
      await new Promise(r => setTimeout(r, BACKOFF_BASE_MS + attempt * 18));
      continue;
    }
  }
  throw new Error("Wikipedia is slow / rate-limiting. Try Next again.");
}

/* ---------- Prefetch queue ---------- */
function prefetchImage(url){
  if (!url) return;
  const img = new Image();
  img.decoding = "async";
  img.loading = "eager";
  img.src = url;
}

async function fillQueue(){
  if (state.prefetching) return;
  state.prefetching = true;
  try{
    while (state.queue.length < state.targetQueue){
      const card = await getNextCard();
      state.queue.push(card);
      if (state.queue.length <= 2) prefetchImage(card.imageUrl);
    }
  } finally {
    state.prefetching = false;
  }
}

function refillQueueSoon(){
  setTimeout(() => fillQueue().catch(()=>{}), 0);
}

/* ---------- Render ---------- */
function renderCard(){
  const c = state.current;
  if (!c) return;

  el("title").textContent = c.title;
  el("concept").textContent = adaptiveExcerpt(c.extract);
  el("openLink").href = c.url;
  setImage(c.imageUrl);

  el("errorText").textContent = "";
  setButtonsEnabled(!state.isLoading);
  updateSaveButtonState();
  setStatus("Ready");
  refillQueueSoon();
}

/* ---------- Actions ---------- */
async function next(){
  if (state.isLoading) return;
  state.isLoading = true;
  setButtonsEnabled(false);
  setStatus("Loading…");

  el("title").textContent = "Loading…";
  el("concept").textContent = "Fetching…";
  setImage(null);

  try{
    let card = state.queue.shift();
    if (!card) card = await getNextCard();

    if (state.current) state.history.push(state.current);
    state.current = card;

    renderCard();
  } catch (e){
    el("title").textContent = "Error";
    el("concept").textContent = String(e?.message || e);
    el("errorText").textContent = "Fetch error. Try again.";
    setStatus("Error", true);
  } finally {
    state.isLoading = false;
    setButtonsEnabled(true);
  }
}

function back(){
  if (state.isLoading) return;
  if (!state.history.length) return;
  state.current = state.history.pop();
  renderCard();
}

function openArticle(){
  const c = state.current;
  if (!c) return;
  window.open(c.url, "_blank", "noopener");
}

function saveCurrent(){
  const c = state.current;
  if (!c) return;

  const key = c.url;
  if (state.saved.some(x => x.url === key)){
    setStatus("Already saved");
    updateSaveButtonState();
    return;
  }

  state.saved.unshift({
    title: c.title,
    url: c.url,
    savedAt: new Date().toISOString(),
    topic: state.choice,
    lang: state.lang
  });

  saveLocal();
  renderSaved();
  updateSaveButtonState();
  setStatus("Saved");
}

function clearSaved(){
  state.saved = [];
  saveLocal();
  renderSaved();
  updateSaveButtonState();
  setStatus("Cleared");
}

/* ---------- Topic + Custom search UI ---------- */
function openCustomUI(){
  el("customWrap").classList.add("show");
  el("customInput").value = state.customQuery || "";
  setTimeout(()=> el("customInput").focus(), 0);
}

function closeCustomUI(){
  el("customWrap").classList.remove("show");
}

async function applyCustomQuery(){
  const q = (el("customInput").value || "").trim();
  state.customQuery = q;
  saveLocal();

  if (!q){
    setStatus(I18N[state.lang]?.customNeedsQuery || "Please type a search term.", true);
    el("errorText").textContent = I18N[state.lang]?.customNeedsQuery || "Please type a search term.";
    return;
  }

  state.queue = [];
  state.history = [];
  setStatus("Loading…");
  await next();
}

async function onTopicChange(key){
  if (!TOPICS.some(t => t.key === key)) return;
  state.choice = key;
  saveLocal();

  state.queue = [];
  state.history = [];

  renderChips();

  if (key === "custom"){
    openCustomUI();
    // Don't auto-next unless we already have a query
    if (state.customQuery && state.customQuery.trim()){
      setStatus("Loading…");
      await next();
    } else {
      setStatus("Ready");
    }
    return;
  } else {
    closeCustomUI();
  }

  setStatus("Loading…");
  await next();
}

/* ---------- Wiring ---------- */
el("next").onclick = next;
el("back").onclick = back;
el("open").onclick = openArticle;
el("save").onclick = saveCurrent;
el("clearSaved").onclick = clearSaved;

document.querySelectorAll(".lang-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    applyLanguage(btn.dataset.lang);
  });
});

// Custom search bar
el("customApply").addEventListener("click", applyCustomQuery);
el("customCancel").addEventListener("click", ()=>{
  // revert to Random when canceling custom
  state.choice = "random";
  saveLocal();
  closeCustomUI();
  renderChips();
  setStatus("Loading…");
  next();
});

el("customInput").addEventListener("keydown", (ev)=>{
  if (ev.key === "Enter"){
    ev.preventDefault();
    applyCustomQuery();
  } else if (ev.key === "Escape"){
    ev.preventDefault();
    el("customCancel").click();
  }
});

/* ---------- Init ---------- */
(function init(){
  loadLocal();

  // Apply saved/default language and mark active button
  applyLanguage(state.lang);

  renderSaved();
  renderChips();

  // set input state
  el("customInput").value = state.customQuery || "";

  setStatus("Loading…");
  el("savedCount").textContent = String(state.saved.length);

  // First render
  next().then(() => refillQueueSoon());
})();
</script>

</body>
</html>