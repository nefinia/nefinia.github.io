<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WikiSwipe — mobile-friendly</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#070A10;
      --stroke:#24304A;
      --stroke2:#2A3856;
      --text:#EAF0FF;
      --muted:#A9B5D1;
      --muted2:#8693B4;
      --accent:#8FB6FF;
      --r:20px;

      /* dynamic typography */
      --title: clamp(22px, 5.2vw, 32px);
      --concept: clamp(16px, 3.8vw, 20px);
      --meta: clamp(12px, 3.2vw, 13px);
      --pad: clamp(12px, 3.2vw, 16px);

      /* FIX: smaller media height so card isn't cut on phones */
      --mediaH: clamp(160px, 35vw, 260px);
    }

    /* FIX: page scrolls naturally; nothing should clip vertically */
    html, body{
      height:auto;
      overflow-y:auto;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(143,182,255,.18), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(124,255,178,.10), transparent 55%),
        radial-gradient(800px 500px at 60% 110%, rgba(255,124,124,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:14px;
    }

    /* FIX: do NOT set height:100vh anywhere; let page scroll */
    .app{
      width:min(760px, 100%);
      display:grid;
      gap:12px;
    }

    .topics{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(10,15,26,.92));
      border-radius: var(--r);
      padding: var(--pad);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .topicsHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .topicsHeader .label{
      font-size:13px; letter-spacing:.3px; color:var(--muted);
      font-weight:750;
    }
    /* FIX: remove confusing hint completely (no "Swipe topics →") */
    .topicsHeader .hint{ display:none; }

    .chipRow{
      display:flex;
      gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:6px;
    }
    .chipRow::-webkit-scrollbar{ height:8px; }
    .chipRow::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; }

    .chip{
      flex:0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(18,23,38,.9);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; gap:8px;
      min-height:40px;
      white-space:nowrap;
    }
    .chip:hover{ border-color: var(--stroke2); transform: translateY(-1px); }
    .chip.active{
      border-color: rgba(143,182,255,.75);
      background: rgba(143,182,255,.10);
    }
    .chip .name{ font-size:13px; font-weight:800; }
    .chip .dot{ width:6px; height:6px; border-radius:999px; background: rgba(143,182,255,.75); opacity:.9; }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(10,15,26,.92));
      border-radius: var(--r);

      /* FIX: don't clip vertically */
      overflow-x:hidden;
      overflow-y:visible;

      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    .media{
      height: var(--mediaH);
      position:relative;
      background:
        radial-gradient(800px 360px at 20% 10%, rgba(143,182,255,.22), transparent 55%),
        radial-gradient(600px 320px at 80% 30%, rgba(255,124,124,.14), transparent 60%),
        radial-gradient(700px 420px at 60% 110%, rgba(124,255,178,.12), transparent 60%),
        #070A10;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .media img{
      width:100%; height:100%;
      object-fit:cover;
      display:none;
      filter:saturate(1.05) contrast(1.03);
    }
    .media .tag{
      position:absolute;
      left:12px; top:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(9,12,18,.45);
      backdrop-filter: blur(8px);
      font-size:12px;
      color:var(--muted);
    }
    .media .spark{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.65;
      background-image:
        radial-gradient(2px 2px at 12% 30%, rgba(255,255,255,.8), transparent 60%),
        radial-gradient(1.6px 1.6px at 22% 55%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(1.8px 1.8px at 38% 20%, rgba(255,255,255,.65), transparent 60%),
        radial-gradient(2px 2px at 48% 70%, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(1.5px 1.5px at 64% 36%, rgba(255,255,255,.6), transparent 60%),
        radial-gradient(2px 2px at 78% 62%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(1.6px 1.6px at 86% 24%, rgba(255,255,255,.65), transparent 60%);
      mix-blend-mode: screen;
    }

    .body{ padding: var(--pad); }

    .title{
      margin:0;
      font-size: var(--title);
      line-height:1.06;
      letter-spacing:-.3px;
      font-weight:900;
      word-break: break-word;
    }

    .meta{
      margin-top:8px;
      font-size: var(--meta);
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .meta a{ color:var(--accent); text-decoration:none; }
    .meta a:hover{ text-decoration:underline; }

    .concept{
      margin-top:12px;
      font-size: var(--concept);
      line-height:1.34;
      color:var(--text);
      letter-spacing:-.1px;
    }

    .bar{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width: 520px){
      .bar{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,23,38,.9);
      color:var(--text);
      padding:12px 10px;
      border-radius:14px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{ border-color: rgba(255,255,255,.16); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    /* FIX: remove keys line; footer shows only status */
    .footer{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      color:var(--muted2);
      font-size:12px;
    }

    .saved{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(9,12,18,.35);
      border-radius:16px;
      padding:12px;
    }
    .saved h3{ margin:0 0 8px 0; font-size:13px; color:var(--muted); }
    .saved ul{ margin:0; padding-left:18px; font-size:13px; line-height:1.45; }
    .saved a{ color:var(--accent); text-decoration:none; }
    .saved a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="app">

    <section class="topics">
      <div class="topicsHeader">
        <div class="label">Topics</div>
        <div class="hint">Browse by topic</div>
      </div>
      <div class="chipRow" id="chipRow"></div>
    </section>

    <main class="card">
      <div class="media">
        <img id="img" alt=""/>
        <div class="spark"></div>
        <div class="tag" id="tag">Random</div>
      </div>

      <div class="body">
        <h1 class="title" id="title">Loading…</h1>
        <div class="meta">
          <span>From Wikipedia</span>
          <span id="metaTopic">· Random</span>
          <a id="openLink" href="#" target="_blank" rel="noopener">open</a>
        </div>

        <div class="concept" id="concept">Fetching a concept…</div>

        <div class="bar">
          <button class="btn" id="back">Back</button>
          <button class="btn" id="next">Next</button>
          <button class="btn" id="article">Article</button>
          <button class="btn" id="save">Save</button>
        </div>

        <div class="footer">
          <div id="status">Ready · Saved: <span id="savedCount">0</span></div>
        </div>

        <div class="saved">
          <h3>Saved</h3>
          <ul id="savedList"></ul>
        </div>
      </div>
    </main>

  </div>

<script>
/*
Fixes included:
- Removed confusing "Swipe topics →" hint
- Removed "Keys: B · N · A · S" line entirely
- Reduced media height on small screens (via CSS var)
- Ensured vertical overflow is never clipped (page scrolls)
- Excerpt is longer (lead paragraph) and adaptive by device width
- Topic relevance uses Wikipedia Search (CirrusSearch)
*/

const LS_SAVED  = "wikiswipe_saved_mobile_v3";
const LS_RECENT = "wikiswipe_recent_mobile_v3";
const LS_CHOICE = "wikiswipe_choice_mobile_v3";

const TOPICS = [
  { key:"random",  label:"Random",    query:null },
  { key:"space",   label:"Astronomy", query:"astronomy OR astrophysics OR galaxy OR cosmology -astrology" },
  { key:"mind",    label:"Mind",      query:"psychology OR neuroscience OR cognition" },
  { key:"history", label:"History",   query:"history OR ancient OR medieval OR revolution" },
  { key:"philo",   label:"Philosophy",query:"philosophy OR ethics OR metaphysics OR epistemology" },
  { key:"bio",     label:"Biology",   query:"biology OR evolution OR genetics OR ecology" },
  { key:"tech",    label:"Tech",      query:"computer science OR software OR algorithm OR engineering" },
  { key:"art",     label:"Arts",      query:"art OR music OR literature OR cinema" },
  { key:"geo",     label:"Earth",     query:"geology OR climate OR ocean OR volcano" },
];

const FETCH_TIMEOUT_MS = 9000;
const RECENT_LIMIT = 500;
const MAX_ATTEMPTS = 60;
const BACKOFF_BASE_MS = 120;

const el = (id) => document.getElementById(id);

const state = {
  choice: "random",
  current: null,
  history: [],
  saved: [],
  recentTitles: [],
  isLoading: false,
};

function loadLocal(){
  try { state.saved = JSON.parse(localStorage.getItem(LS_SAVED) || "[]"); } catch { state.saved = []; }
  try { state.recentTitles = JSON.parse(localStorage.getItem(LS_RECENT) || "[]"); } catch { state.recentTitles = []; }
  const c = localStorage.getItem(LS_CHOICE);
  if (c && TOPICS.some(t => t.key === c)) state.choice = c;
}

function saveLocal(){
  localStorage.setItem(LS_SAVED, JSON.stringify(state.saved.slice(0, 500)));
  localStorage.setItem(LS_RECENT, JSON.stringify(state.recentTitles.slice(0, RECENT_LIMIT)));
  localStorage.setItem(LS_CHOICE, state.choice);
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function setStatus(text){
  el("status").innerHTML = `${escapeHtml(text)} · Saved: <span id="savedCount">${state.saved.length}</span>`;
}

function setButtonsEnabled(enabled){
  for (const id of ["back","next","article","save"]) el(id).disabled = !enabled;
  el("back").disabled = !(enabled && state.history.length > 0);
}

function setImage(url){
  const img = el("img");
  if (url){
    img.src = url;
    img.style.display = "block";
  } else {
    img.removeAttribute("src");
    img.style.display = "none";
  }
}

/* -------- Excerpt: lead paragraph, adaptive -------- */
function leadParagraph(text){
  if (!text) return "";
  return text
    .split(/\n{2,}/g)
    .map(p => p.trim())
    .filter(Boolean)[0] || text.trim();
}

function clampWords(text, maxWords){
  const words = (text || "").trim().split(/\s+/).filter(Boolean);
  if (words.length <= maxWords) return (text || "").trim();
  return words.slice(0, maxWords).join(" ") + "…";
}

function adaptiveMaxWords(){
  const w = window.innerWidth;
  if (w < 420) return 75;   // small phones
  if (w < 600) return 90;   // phones
  if (w < 900) return 110;  // tablets
  return 140;               // desktops
}

function adaptiveExcerpt(text){
  return clampWords(leadParagraph(text), adaptiveMaxWords());
}

window.addEventListener("resize", () => {
  if (state.current) el("concept").textContent = adaptiveExcerpt(state.current.extract);
});

/* --------- De-dupe --------- */
function rememberTitle(title){
  if (!title) return;
  state.recentTitles.unshift(title);
  state.recentTitles = [...new Set(state.recentTitles)].slice(0, RECENT_LIMIT);
  saveLocal();
}

/* --------- UI: chips --------- */
function renderChips(){
  const row = el("chipRow");
  row.innerHTML = "";
  for (const t of TOPICS){
    const chip = document.createElement("div");
    chip.className = "chip" + (state.choice === t.key ? " active" : "");
    chip.innerHTML = `<span class="dot"></span><span class="name">${escapeHtml(t.label)}</span>`;
    chip.onclick = async () => {
      state.choice = t.key;
      saveLocal();
      renderChips();
      await next();
    };
    row.appendChild(chip);
  }
  const label = TOPICS.find(t => t.key === state.choice)?.label || "Random";
  el("tag").textContent = label;
  el("metaTopic").textContent = `· ${label}`;
}

/* --------- Networking --------- */
async function fetchWithTimeout(url, options={}){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);
  try{
    return await fetch(url, { ...options, signal: controller.signal });
  } finally {
    clearTimeout(t);
  }
}

async function jsonOrThrow(res){
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return await res.json();
}

function isBadSummary(s){
  if (!s) return true;
  if (s.type === "disambiguation") return true;
  const t = s.title || "";
  if (/^(Category:|Help:|Wikipedia:|Template:|File:|Portal:|Draft:|Special:)/i.test(t)) return true;
  if (!s.extract) return true;
  return false;
}

async function fetchRandomTitle(){
  const url = new URL("https://en.wikipedia.org/w/api.php");
  url.searchParams.set("action","query");
  url.searchParams.set("list","random");
  url.searchParams.set("rnnamespace","0");
  url.searchParams.set("rnlimit","1");
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  return j?.query?.random?.[0]?.title || null;
}

async function fetchSummaryByTitle(title){
  const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
  const res = await fetchWithTimeout(url, { headers: { "accept":"application/json" }});
  return await jsonOrThrow(res);
}

async function fetchRevisionId(title){
  const url = new URL("https://en.wikipedia.org/w/api.php");
  url.searchParams.set("action","query");
  url.searchParams.set("prop","revisions");
  url.searchParams.set("titles",title);
  url.searchParams.set("rvprop","ids");
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  const pages = j?.query?.pages;
  const page = pages ? pages[Object.keys(pages)[0]] : null;
  return page?.revisions?.[0]?.revid || null;
}

/* ---- Search-based topic randomization ---- */
async function searchTotalHits(query){
  const url = new URL("https://en.wikipedia.org/w/api.php");
  url.searchParams.set("action","query");
  url.searchParams.set("list","search");
  url.searchParams.set("srsearch", query);
  url.searchParams.set("srnamespace","0");
  url.searchParams.set("srlimit","1");
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  return j?.query?.searchinfo?.totalhits || 0;
}

async function searchTitles(query, offset, limit=30){
  const url = new URL("https://en.wikipedia.org/w/api.php");
  url.searchParams.set("action","query");
  url.searchParams.set("list","search");
  url.searchParams.set("srsearch", query);
  url.searchParams.set("srnamespace","0");
  url.searchParams.set("srlimit", String(limit));
  url.searchParams.set("sroffset", String(offset));
  url.searchParams.set("format","json");
  url.searchParams.set("origin","*");
  const res = await fetchWithTimeout(url.toString());
  const j = await jsonOrThrow(res);
  return (j?.query?.search || []).map(x => x.title);
}

async function makeCardFromSummary(summary){
  const title = summary.title;
  const url = summary?.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`;
  const imageUrl = summary?.thumbnail?.source || summary?.originalimage?.source || null;

  const oldid = await fetchRevisionId(title);
  const oldidUrl = oldid
    ? `https://en.wikipedia.org/w/index.php?title=${encodeURIComponent(title)}&oldid=${oldid}`
    : url;

  return { title, extract: summary.extract, url, oldidUrl, imageUrl, ts:new Date().toISOString() };
}

async function getNextCard(){
  const topic = TOPICS.find(t => t.key === state.choice) || TOPICS[0];

  for (let attempt=0; attempt<MAX_ATTEMPTS; attempt++){
    try{
      let title = null;

      if (topic.key === "random" || !topic.query){
        title = await fetchRandomTitle();
      } else {
        const total = await searchTotalHits(topic.query);
        const cap = Math.min(total, 5000);
        const offset = cap > 0 ? Math.floor(Math.random() * cap) : 0;
        const titles = await searchTitles(topic.query, offset, 30);
        title = titles.length ? titles[Math.floor(Math.random() * titles.length)] : await fetchRandomTitle();
      }

      if (!title) continue;
      if (state.recentTitles.includes(title)) continue;

      const s = await fetchSummaryByTitle(title);
      if (isBadSummary(s)) continue;

      const card = await makeCardFromSummary(s);
      rememberTitle(card.title);
      return card;

    } catch {
      await new Promise(r => setTimeout(r, BACKOFF_BASE_MS + attempt * 18));
      continue;
    }
  }

  throw new Error("Wikipedia is flaky / rate-limiting right now. Try again.");
}

/* --------- Render --------- */
function renderSaved(){
  const savedCountEl = document.getElementById("savedCount");
  if (savedCountEl) savedCountEl.textContent = String(state.saved.length);

  const list = el("savedList");
  list.innerHTML = "";
  state.saved.slice(0, 12).forEach(item => {
    const li = document.createElement("li");
    li.innerHTML = `<a href="${item.oldidUrl || item.url}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>`;
    list.appendChild(li);
  });
}

function renderCard(){
  const c = state.current;
  if (!c) return;

  el("title").textContent = c.title;
  el("concept").textContent = adaptiveExcerpt(c.extract);
  el("openLink").href = c.oldidUrl || c.url;

  setImage(c.imageUrl);
  renderChips();
  setButtonsEnabled(!state.isLoading);
}

/* --------- Actions --------- */
async function next(){
  if (state.isLoading) return;
  state.isLoading = true;
  setButtonsEnabled(false);
  setStatus("Loading…");

  el("title").textContent = "Loading…";
  el("concept").textContent = "Fetching a concept…";
  setImage(null);

  try{
    const card = await getNextCard();
    if (state.current) state.history.push(state.current);
    state.current = card;

    renderCard();
    setStatus("Ready");
  } catch (e){
    el("title").textContent = "Error";
    el("concept").textContent = String(e?.message || e);
    setStatus("Error");
  } finally {
    state.isLoading = false;
    setButtonsEnabled(true);
  }
}

function back(){
  if (state.isLoading) return;
  if (!state.history.length) return;
  state.current = state.history.pop();
  renderCard();
  setStatus("Ready");
}

function openArticle(){
  const c = state.current;
  if (!c) return;
  window.open(c.oldidUrl || c.url, "_blank", "noopener");
}

function doSave(){
  const c = state.current;
  if (!c) return;

  const key = c.oldidUrl || c.url;
  if (state.saved.some(x => (x.oldidUrl || x.url) === key)) return;

  state.saved.unshift({
    title: c.title,
    url: c.url,
    oldidUrl: c.oldidUrl,
    imageUrl: c.imageUrl,
    excerpt: adaptiveExcerpt(c.extract),
    savedAt: new Date().toISOString(),
    topic: state.choice
  });
  saveLocal();
  renderSaved();
  setStatus("Saved");
}

/* --------- Wiring --------- */
el("back").onclick = back;
el("next").onclick = next;
el("article").onclick = openArticle;
el("save").onclick = doSave;

/* (Optional) keep keyboard shortcuts but don't advertise them */
window.addEventListener("keydown", (e) => {
  const k = e.key.toLowerCase();
  if (k === "b") back();
  if (k === "n") next();
  if (k === "a") openArticle();
  if (k === "s") doSave();
});

/* --------- Init --------- */
(function init(){
  loadLocal();
  renderChips();
  renderSaved();
  setStatus("Ready");
  next();
})();
</script>
</body>
</html>